---
title: "R Notebook"
output: html_notebook
---

#para analizar
```{r}
#rm(list = ls())

library(httr)
library(jsonlite)
library(lubridate)
library(openxlsx)
library(dplyr)
```

#para graficar
```{r}
library(ggplot2) #graficos
library(gganimate) #animacion
library(gifski) #gif support
library(av) #video support
library(stringr) #para acomodar texto
```


```{r}
#para grabar espacio de trabajo
#save.image(file = "D:/Mego/Big_Data/api_nyt.RData")
load("D:/Mego/Big_Data/api_nyt.RData")
```


# AQUI VAMOS A TRER LAS NOTAS DEL NEW YORK TIMES

```{r}
ty=2020 # year
tm=7 # month
#url_nyt = "https://api.nytimes.com/svc/archive/v1/2020/3.json"

url_nyt=paste0('https://api.nytimes.com/svc/archive/v1/',ty,'/',tm,'.json')
querystring_nyt = list('api-key'="XXXXXXXXX")
```


```{r}
nyt_0 <- GET(url_nyt,query=querystring_nyt)
nyt_0
```

```{r}
nyt_1 <- fromJSON(content(nyt_0, type = "text"))
df_nyt<-nyt_1[["response"]][["docs"]]
df_nyt$period<-ifelse(nchar(tm)==1,paste0(ty,'0',tm),paste0(ty,tm))
```

#back up
```{r}
df_nyt_202002<-df_nyt
```

#limpieza
```{r}
rm(df_nyt)
rm(url_nyt)
rm(querystring_nyt)
rm(nyt_0)
rm(nyt_1)
```

#eligo la data para obtener dataframe de prod, tags y byline (autores)
```{r}
df_nyt<-df_nyt_202001
```

#si es que no tiene el campo period
```{r}
df_nyt$period<-'202001'
```

#creo el dataframe prod
```{r}
df_nyt_prod<-select(df_nyt,'_id',web_url,abstract,snippet,lead_paragraph,print_section,
                     print_page,source,pub_date,document_type,news_desk,section_name,subsection_name,
                     type_of_material,word_count,uri,slideshow_credits,period)
df_nyt_prod$headline<-df_nyt_prod$headline$main
```

#creo el dataframe tag y byline
```{r}
#hago un consolidado de tags, byline y multimedia #falta agregar el mes para correr todo el loop
df_tag<-data.frame()
df_byline<-data.frame()
for(i in 1:nrow(df_nyt)){
  if (nrow(df_nyt[i,]$keywords[[1]])>0) #bloque tags
    {
      df_x<-df_nyt[i,]$keywords[[1]]
      df_x$id<-df_nyt[i,]$'_id'
      df_x$url<-df_nyt[i,]$web_url
      df_x$period<-df_nyt[i,]$period
      df_tag<-rbind(df_tag,df_x)
    }

  
  if (nrow(df_nyt[i,]$byline[[2]][[1]])>0) #bloque byline #tiene una lista dentro de otra lista
    {
      df_y<-df_nyt[i,]$byline[[2]][[1]]
      df_y$id<-df_nyt[i,]$'_id'
      df_y$original<-df_nyt[i,]$byline[[1]]
      df_y$url<-df_nyt[i,]$web_url
      df_y$period<-df_nyt[i,]$period
      df_byline<-rbind(df_byline,df_y)
    }

}
rm(i,df_x,df_y)
```


#back up
```{r}
df_nyt_prod_202001<-df_nyt_prod
df_tag_202001<-df_tag
df_byline_202001<-df_byline
rm(df_nyt,df_nyt_prod,df_tag,df_byline)
```


write.xlsx(df_nyt_prod_202007,"D:/Mego/Big_Data/Outputs/df_nyt_prod_202007.xlsx", sheetName="Sheet1", 
  col.names=TRUE, row.names=FALSE, append=FALSE)

write.xlsx(df_tag_202007,"D:/Mego/Big_Data/Outputs/df_tag_202007.xlsx", sheetName="Sheet1", 
  col.names=TRUE, row.names=FALSE, append=FALSE)

write.xlsx(df_byline_202007,"D:/Mego/Big_Data/Outputs/df_byline_202007.xlsx", sheetName="Sheet1", 
  col.names=TRUE, row.names=FALSE, append=FALSE)



###consolidacion de data traida del proceos automatico

```{r}
df_nyt_prod_c<-read.csv("D:/Mego/Big_Data/Outputs/df_nyt_prod_c_201808.csv")
```

```{r}
df_tag_c<-read.csv("D:/Mego/Big_Data/Outputs/df_tag_c_201808.csv")
```

```{r}
df_byline_c<-read.csv("D:/Mego/Big_Data/Outputs/df_byline_c_201808.csv")
```


```{r}
df_nyt_prod_c2 <- rename(df_nyt_prod_c2, c(X_id='_id'))
```


```{r}
data.frame(table(df_nyt_prod_c3$period))
data.frame(table(df_tag_c3$period))
data.frame(table(df_byline_c3$period))
```


#analisis

```{r}
head(df_tag_c3)
```

```{r}
df_tag_ag1<-df_tag_c3%>%count(period,value)
```


```{r}
df_tag_ag1 <- rename(df_tag_ag1, c(notas=n))
```

```{r}
df_tag_ag1 <- rename(df_tag_ag1, c(tag=value))
```



```{r}
df_tag_ag2<-
  df_tag_ag1%>%
  group_by(period)%>%
  mutate(per=prop.table(notas)*100)
```

```{r}
sum(df_tag_ag2[df_tag_ag2$period=='202001',]$per)
sum(df_tag_ag2$per)
```

```{r}
df_tag_ag <- df_tag_ag2 %>%
  group_by(period) %>%
  arrange(period, desc(notas)) %>%
  mutate(ranking = row_number()) %>%
  filter(ranking <=15)
```


```{r}
sum(df_tag_ag[df_tag_ag$period=='202001',]$per)
sum(df_tag_ag$per)
```
```{r}
df_tag_ag<-mutate(df_tag_ag,per=round(per,digits=2))
```


```{r}
head(df_tag_ag)
```

```{r}
df_tag_ag_demo<-subset(df_tag_ag,period>='202001')
```


```{r}
animacion <- df_tag_ag %>%
  ggplot() +
  geom_col(aes(ranking, per, fill = tag,width=0.9)) +
  geom_text(aes(ranking, per, label = as.factor(per)), hjust=-0.1) +
  geom_text(aes(ranking, y=0 , label = substr(tag,1,30)), hjust=1.1) +
  geom_text(aes(x=15, y=max(per) , label = as.factor(period)),
            vjust = 0.2, alpha = 0.6,  col = "gray", size = 20) +
  coord_flip(clip = "off", expand = TRUE) + scale_x_reverse() +
  theme_minimal() + 
  theme(
    panel.grid = element_blank(), 
    legend.position = "none",
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    plot.margin = margin(1, 4, 1, 8, "cm")
  ) +
  transition_states(period, state_length = 0, transition_length = 2) +
  labs(title = "New York Times:\nTop 15 Tags evolucion",y = "Porcentaje de uso de tag")+
  enter_fade() +
  exit_fade() + 
  ease_aes('quadratic-in-out')


    plot(animacion)
```

```{r}
animate(animacion, width = 1000 , height = 432, fps = 25, duration = 244, rewind = FALSE)
```

#en video
animate(animacion, renderer = av_renderer())

```{r}
write.xlsx(df_tag_ag,"D:/Mego/Big_data/Outputs/df_tag_ag.xlsx",row.names=FALSE)
```


```{r}
write.xlsx(df_tag_ag2,"D:/Mego/Big_data/Outputs/df_tag_ag2.xlsx",row.names=FALSE)
```

